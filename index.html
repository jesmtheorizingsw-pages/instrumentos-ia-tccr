<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas Cognosist√©micas de la TCCR</title>
    <!-- Incluyendo Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Usamos la fuente Inter, o un fallback sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Gris claro de fondo */
        }
        /* Estilo para el fondo del hero */
        .tool-header-bg {
            background-image: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316; /* Naranja de Tailwind para foco */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Contenedor Principal Centrado -->
    <div class="min-h-screen flex flex-col items-center p-4 sm:p-8">

        <!-- T√≠tulo principal de la herramienta -->
        <header class="w-full max-w-4xl tool-header-bg text-white shadow-2xl rounded-xl p-6 mb-8 text-center border-b-8 border-yellow-500">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-1 text-yellow-300">
                INSTRUMENTAL COGNOSIST√âMICO
            </h1>
            <h2 class="text-lg sm:text-xl font-light text-gray-300">
                Herramientas de Intervenci√≥n impulsadas por IA (Marco TCCR)
            </h2>
        </header>

        <!-- Contenido Principal: SOLO Herramientas -->
        <main class="w-full max-w-4xl space-y-6">

            <!-- Bloque de Herramientas LLM (Mantenido) -->
            <section class="bg-gray-100 p-6 sm:p-8 rounded-xl shadow-lg border-l-8 border-yellow-500 space-y-6">
                
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center justify-center border-b pb-3">
                    <svg class="w-7 h-7 mr-3 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 100 2h3a1 1 0 100-2h-3zM5 4a1 1 0 112 0v2h2a1 1 0 010 2h-2v2a1 1 0 11-2 0V8H3a1 1 0 010-2h2V4zM12 11a1 1 0 100 2h3a1 1 0 100-2h-3zM12 15a1 1 0 100 2h3a1 1 0 100-2h-3zM10 2a8 8 0 100 16 8 8 0 000-16z"></path></svg>
                    FUNCIONES PARA EL TRABAJO SOCIAL
                </h3>
                
                <!-- Contenedor de Interacci√≥n 1: Consulta Conceptual TCCR (Q&A) -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-orange-500">
                    <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        1. üí° Consulta Conceptual TCCR (Q&A)
                    </h4>
                    <p class="text-sm text-gray-600 mb-3">
                        Pregunte sobre cualquier concepto, elemento o pilar de la TCCR. La IA responder√° de forma rigurosa y acad√©mica, bas√°ndose <strong>estrictamente</strong> en el marco te√≥rico de Jalin Simunovic (2025).
                    </p>
                    <textarea id="qaInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 mb-3" rows="2" placeholder="Ej: ¬øCu√°l es el rol de la 'Actitud Epist√©mica' en la TCCR?"></textarea>
                    <button id="queryTCCRBtn" class="w-full px-4 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition duration-150 flex items-center justify-center shadow-lg">
                        <span id="qaBtnText">Consultar Concepto TCCR</span>
                        <div id="qaLoading" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <div id="qaOutput" class="mt-4 p-4 bg-orange-50 border-l-4 border-orange-400 text-gray-700 rounded-lg hidden">
                        <p class="font-bold text-orange-800 mb-1">Respuesta Cognosist√©mica:</p>
                        <div id="qaText" class="prose max-w-none text-sm"></div>
                    </div>
                </div>

                <!-- Contenedor de Interacci√≥n 2: Generador de Memes -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500">
                    <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        2. ‚ú® Generador de Memes Cognosist√©micos
                    </h4>
                    <p class="text-sm text-gray-600 mb-3">
                        Ingrese una narrativa social, problem√°tica o hegem√≥nica (ej: "La desigualdad es un ciclo inevitable"). La IA generar√° un Meme Cognosist√©mico estrat√©gico (unidad de significado transformador) para desafiarla desde la TCCR.
                    </p>
                    <textarea id="memeInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3" rows="3" placeholder="Narrativa a deconstruir (ej: El asistencialismo es la √∫nica soluci√≥n)."></textarea>
                    <button id="generateMemeBtn" class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center shadow-lg">
                        <span id="memeBtnText">Generar Meme Transformador</span>
                        <div id="memeLoading" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <div id="memeOutput" class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 text-gray-700 rounded-lg hidden">
                        <p class="font-bold text-blue-800 mb-1">Resultado del Meme Cognosist√©mico:</p>
                        <p id="memeText"></p>
                    </div>
                </div>

                <!-- Contenedor de Interacci√≥n 3: An√°lisis de Narrativa (Grounded) -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-teal-500">
                    <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                        3. üîé An√°lisis de Narrativa Psicosocial (Ecosist√©mico)
                    </h4>
                    <p class="text-sm text-gray-600 mb-3">
                        Describa una problem√°tica social o una situaci√≥n de intervenci√≥n. La IA analizar√° la narrativa usando la Tripleta TCCR y los Niveles Ecosist√©micos, pudiendo usar b√∫squeda web para contexto.
                    </p>
                    <textarea id="analysisInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-3" rows="4" placeholder="Describa la narrativa psicosocial a analizar (ej: Crisis migratoria en el macrosistema)."></textarea>
                    <button id="analyzeBtn" class="w-full px-4 py-2 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition duration-150 flex items-center justify-center shadow-lg">
                        <span id="analysisBtnText">Analizar con Tripleta TCCR</span>
                        <div id="analysisLoading" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <div id="analysisOutput" class="mt-4 p-4 bg-teal-50 border-l-4 border-teal-400 text-gray-700 rounded-lg hidden">
                        <p class="font-bold text-teal-800 mb-1">An√°lisis Ecosist√©mico-Narrativo (TCCR):</p>
                        <div id="analysisText" class="prose max-w-none text-sm"></div>
                        <div id="analysisSources" class="text-xs mt-3 italic text-gray-500"></div>
                    </div>
                </div>
            </section>

        </main>

        <!-- Nuevo Pie de P√°gina de Licencia -->
        <footer class="text-center text-sm text-gray-600 pt-6 mt-6 pb-8">
            <p>Instrumental Cognosist√©mico ¬© 2025 por Jalin Simunovic tiene licencia CC BY 4.0</p>
        </footer>
    </div>

    <!-- Script de Inicializaci√≥n y L√≥gica LLM (ACTUALIZADO CON REGLAS DE ORO COMPLETAS) -->
    <script type="module">
        // Variables globales para la API
        const ENDPOINT = "https://timely-hummingbird-fa79a0.netlify.app/.netlify/functions/gemini";
        const APP_TOKEN = ""; // opcional: si activaste APP_CLIENT_TOKEN en Netlify, col√≥calo aqu√≠
        
        // --- Elementos del DOM ---
        
        // 1. Q&A Conceptual
        const qaInput = document.getElementById('qaInput');
        const queryTCCRBtn = document.getElementById('queryTCCRBtn');
        const qaOutput = document.getElementById('qaOutput');
        const qaText = document.getElementById('qaText');
        const qaLoading = document.getElementById('qaLoading');
        const qaBtnText = document.getElementById('qaBtnText');

        // 2. Generador de Memes
        const memeInput = document.getElementById('memeInput');
        const generateMemeBtn = document.getElementById('generateMemeBtn');
        const memeOutput = document.getElementById('memeOutput');
        const memeText = document.getElementById('memeText');
        const memeLoading = document.getElementById('memeLoading');
        const memeBtnText = document.getElementById('memeBtnText');

        // 3. An√°lisis Narrativo
        const analysisInput = document.getElementById('analysisInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisOutput = document.getElementById('analysisOutput');
        const analysisText = document.getElementById('analysisText');
        const analysisLoading = document.getElementById('analysisLoading');
        const analysisBtnText = document.getElementById('analysisBtnText');
        const analysisSources = document.getElementById('analysisSources');
        
        // --- Funciones de Utilidad ---

        /** Limpia el texto de salida de la IA, eliminando los dobles asteriscos (**) 
         * y convirtiendo los saltos de l√≠nea (\n) a <br>.
         */
        function cleanTextForOutput(text) {
            // 1. Quitar asteriscos dobles (**)
            let cleanedText = text.replace(/\*\*/g, '').trim();
            // 2. Convertir saltos de l√≠nea para HTML
            cleanedText = cleanedText.replace(/\n/g, '<br>');
            return cleanedText;
        }

        /** Maneja las peticiones con reintentos y backoff exponencial */
        async function fetchWithRetry(url, payload, maxRetries = 5) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Si la clave API est√° vac√≠a, Canvas la inyectar√°.
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-App-Key': APP_TOKEN },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    lastError = error;
                    // Retardo exponencial (1s, 2s, 4s, 8s...)
                    const delay = Math.pow(2, i) * 1000;
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            console.error("Failed to fetch from API after multiple retries:", lastError);
            // Mostrar un error de conexi√≥n gen√©rico si fallan todos los reintentos
            throw new Error("No se pudo conectar con el servicio de IA. Verifique su conexi√≥n o intente m√°s tarde.");
        }
        
        // --- REGLAS DE ORO CONCEPTUALES DE LA TCCR (SISTEMA DE FILTROS COMPLETO) ---
        // Se ha sintetizado todo el marco conceptual del documento en esta restricci√≥n de sistema.
        const TCCR_GOLD_RULES_CORE = `
            Usted es un trabajador social experto y riguroso en la Teor√≠a Cognosist√©mica de la Construcci√≥n Relacional Psicosocial Humana (TCCR) de Jalin Simunovic (2025).

            RIGOR ACAD√âMICO - REGLAS DE ORO FUNDAMENTALES:
            1. Anclaje Paradigm√°tico: Toda respuesta debe preservar la mirada cognosist√©mica: la realidad psicosocial es una construcci√≥n narrativa relacional dentro de Cognosistemas, considerando multinivelidad, jerarqu√≠as narrativas, poder, historicidad y validaci√≥n √©tica.
            2. Regla Cognosistema: El Cognosistema es un **suprasistema narrativo ecosist√©mico** que siempre se ancla a una **sociedad espec√≠fica** (y su periodo). **NUNCA** lo asigne a un individuo, familia, grupo u organizaci√≥n de forma aislada (estos son Sistemas Narrativos o capas dentro del Cognosistema).
            3. Regla Tripleta TCCR: Para el an√°lisis, use siempre los tres pilares: **Ontolog√≠a Sist√©mico-Relacional**, **Epistemolog√≠a Cognosist√©mica** y **Metodolog√≠a Ecosist√©mica-Narrativa** (articulaci√≥n micro/meso/macro y justicia social).
            4. Regla SNC (Unidad de An√°lisis): El Sistema Narrativo Cognosist√©mico (SNC) es la unidad dentro del Cognosistema. Debe estar definido por sus **8 elementos interdependientes**: Experiencia; Percepciones y Emociones; Contexto; Contenido Proposicional (N√∫cleo); Evaluaci√≥n Cognitiva (Cuerpo); Actitud Epist√©mica; Prop√≥sito Narrativo; Funci√≥n Narrativa. **Diferencie rigurosamente N√∫cleo vs. Cuerpo y Prop√≥sito vs. Funci√≥n.**
            5. Regla Ciclo Vital Narrativo: Las fases del Ciclo Vital Narrativo son **OBLIGATORIAMENTE cinco**: **Surgimiento**, **Desarrollo**, **Madurez**, **Declive o Transformaci√≥n**, y **Renovaci√≥n**.
            6. Regla Din√°mica de Cambio: El cambio cognosist√©mico opera bajo las fases de: **Fase Beta** (Estabilidad/Inercia), **Fase Alfa** (Crisis/Fricci√≥n) y **Fase Delta** (Reorganizaci√≥n/Transformaci√≥n). Las fricciones son esenciales y estructurales.
            7. Regla Jerarqu√≠a y Movilidad: El Cognosistema est√° estratificado. Las narrativas se clasifican (hegem√≥nicas, desafiantes, subyugadas, etc.) y experimentan **Movilidad** (Ascendente, Descendente, Horizontal).
            8. Regla Meme Cognosist√©mico: Es una unidad narrativa **intencionalmente dise√±ada** para incidir socioculturalmente (veh√≠culo, transformador, difusor) con una tipolog√≠a espec√≠fica (Consolidaci√≥n, Fricci√≥n, Transici√≥n).
            9. Formato: NO use asteriscos dobles (**) para el formateo.
            
            Su rol espec√≠fico para esta interacci√≥n es: 
        `;


        // --- 1. Consulta Conceptual TCCR (Q&A) ---

        queryTCCRBtn.addEventListener('click', async () => {
            const userQuery = qaInput.value.trim();
            if (!userQuery) {
                qaText.innerHTML = "Por favor, formule una pregunta conceptual sobre la TCCR.";
                qaOutput.classList.remove('hidden');
                return;
            }
            
            qaBtnText.textContent = 'Consultando...';
            qaLoading.classList.remove('hidden');
            queryTCCRBtn.disabled = true;
            qaOutput.classList.add('hidden');
            
            const systemPrompt = TCCR_GOLD_RULES_CORE + `Responder preguntas conceptuales exclusivamente con el rigor acad√©mico de este marco te√≥rico de la TCCR. No uses conocimiento externo o ajeno a la TCCR. Responde de manera clara, concisa y utilizando la terminolog√≠a espec√≠fica de la TCCR.`;

            const payload = { text: userQuery, systemInstruction: systemPrompt };

            try {
                const result = await fetchWithRetry(ENDPOINT, payload);
                const text = result?.output?.text || "Error en la generaci√≥n del contenido.";
                
                // Aplicar el filtro de limpieza al texto generado
                qaText.innerHTML = cleanTextForOutput(text);
                
            } catch (error) {
                console.error(error);
                qaText.innerHTML = error.message || "Ocurri√≥ un error al consultar el concepto TCCR. Revise la consola para detalles t√©cnicos.";
            } finally {
                qaBtnText.textContent = 'Consultar Concepto TCCR';
                qaLoading.classList.add('hidden');
                queryTCCRBtn.disabled = false;
                qaOutput.classList.remove('hidden');
            }
        });


        // --- 2. Generador de Memes Cognosist√©micos ---

        generateMemeBtn.addEventListener('click', async () => {
            const userNarrative = memeInput.value.trim();
            if (!userNarrative) {
                memeText.textContent = "Por favor, ingrese una narrativa para generar el Meme Cognosist√©mico.";
                memeOutput.classList.remove('hidden');
                return;
            }
            
            memeBtnText.textContent = 'Generando...';
            memeLoading.classList.remove('hidden');
            generateMemeBtn.disabled = true;
            memeOutput.classList.add('hidden');
            
            const systemPrompt = TCCR_GOLD_RULES_CORE + `Generar un "Meme Cognosist√©mico" (unidad de significado estrat√©gica, concisa y potente) que contradiga/transforme la narrativa subyugante proporcionada. El Meme debe basarse en la ontolog√≠a sist√©mico-relacional y promover la justicia social. El resultado debe ser solo el meme (una frase corta e impactante) y una breve explicaci√≥n de 2-3 l√≠neas de su prop√≥sito transformador, indicando su tipo funcional (Fricci√≥n, Transici√≥n o Consolidaci√≥n) si aplica.`;

            const userQuery = `Narrativa dominante o problem√°tica: "${userNarrative}". Genera el Meme Cognosist√©mico transformador y su explicaci√≥n.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(ENDPOINT, payload);
                const text = result?.output?.text || "Error en la generaci√≥n del contenido.";
                
                // Formateo del resultado: separamos el meme de la explicaci√≥n
                const parts = text.split('\n').filter(p => p.trim() !== '');
                if (parts.length >= 2) {
                    // Limpiamos los asteriscos de la l√≠nea del meme y el texto explicativo
                    const memeLine = parts[0].replace(/\*\*/g, '').trim(); 
                    const explanationText = parts.slice(1).join('\n');
                    memeText.innerHTML = `<span class="text-xl font-extrabold text-blue-700 block mb-2">"${memeLine}"</span><p>${cleanTextForOutput(explanationText)}</p>`;
                } else {
                    memeText.textContent = text.replace(/\*\*/g, ''); // Limpieza simple si no hay formato de meme
                }
                
            } catch (error) {
                console.error(error);
                memeText.textContent = error.message || "Ocurri√≥ un error al generar el Meme Cognosist√©mico. Revise la consola para detalles t√©cnicos.";
            } finally {
                memeBtnText.textContent = 'Generar Meme Transformador';
                memeLoading.classList.add('hidden');
                generateMemeBtn.disabled = false;
                memeOutput.classList.remove('hidden');
            }
        });

        // --- 3. An√°lisis de Narrativa Psicosocial (Grounded) ---

        analyzeBtn.addEventListener('click', async () => {
            const userNarrative = analysisInput.value.trim();
            if (!userNarrative) {
                analysisText.innerHTML = "<p>Por favor, describa una situaci√≥n o narrativa para que la IA la analice con el marco TCCR.</p>";
                analysisOutput.classList.remove('hidden');
                return;
            }

            analysisBtnText.textContent = 'Analizando...';
            analysisLoading.classList.remove('hidden');
            analyzeBtn.disabled = true;
            analysisOutput.classList.add('hidden');
            
            const systemPrompt = TCCR_GOLD_RULES_CORE + `Analizar la narrativa/situaci√≥n psicosocial aplicando rigurosamente la **Tripleta TCCR** y la din√°mica de **Niveles Ecosist√©micos** (micro, meso, exo, macro). Tu respuesta debe ser concisa, estructurada y en espa√±ol. Utiliza Google Search para fundamentar el an√°lisis si la problem√°tica es de actualidad o requiere datos externos. **Nunca confundas el Cognosistema con el caso particular.**`;

            const userQuery = `Analiza el siguiente caso/situaci√≥n con la TCCR, identificando la Tripleta y los niveles de intervenci√≥n requeridos: "${userNarrative}".`;

            const payload = { text: userQuery, systemInstruction: systemPrompt };
            // Nota: si m√°s adelante quieres grounding, habr√≠a que exponer `raw` en el backend.

            try {
                const result = await fetchWithRetry(ENDPOINT, payload);
                const candidate = undefined; // sin 'raw' desde backend gen√©rico
                const text = result?.output?.text || "Error en la generaci√≥n del contenido.";

                // 1. Extraer texto y aplicar el filtro de limpieza
                analysisText.innerHTML = cleanTextForOutput(text);

                // 2. Extraer fuentes (grounding sources)
                let sources = [];
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                if (sources.length > 0) {
                    let sourcesHtml = 'Fuentes citadas (Grounding): ';
                    sources.forEach((source, index) => {
                        sourcesHtml += `<a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700">${source.title}</a>${index < sources.length - 1 ? ', ' : ''}`;
                    });
                    analysisSources.innerHTML = sourcesHtml;
                } else {
                    analysisSources.innerHTML = '';
                }
                
            } catch (error) {
                console.error(error);
                analysisText.innerHTML = `<p>${error.message || "Ocurri√≥ un error al realizar el an√°lisis. Revise la consola para detalles t√©cnicos."}</p>`;
                analysisSources.innerHTML = '';
            } finally {
                analysisBtnText.textContent = 'Analizar con Tripleta TCCR';
                analysisLoading.classList.add('hidden');
                analyzeBtn.disabled = false;
                analysisOutput.classList.remove('hidden');
            }
        });
    </script>

</body>
</html>
